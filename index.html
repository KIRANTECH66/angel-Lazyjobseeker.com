<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebase.com https://*.google.com">
    <title>Angel - AI Meeting Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --gradient-start: #6366f1;
            --gradient-end: #8b5cf6;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --text: #1e293b;
            --text-light: #64748b;
            --background: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --transition: all 0.2s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.25rem;
            line-height: 1.5;
            font-size: 0.875rem;
        }
        
        .container {
            width: 100%;
            max-width: 450px;
            height: 85vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* Sign In Screen Styles */
        .sign-in-screen {
            text-align: center;
            padding: 1rem 0.5rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: var(--radius-lg);
            color: white;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }
        
        .sign-in-btn {
            background: white;
            color: var(--primary);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sign-in-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .upgrade-prompt {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            box-shadow: var(--shadow-lg);
        }
        
        .upgrade-prompt h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .upgrade-prompt p {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }
        
        .upgrade-btn {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: var(--transition);
        }
        
        .upgrade-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Welcome Screen Styles */
        .welcome-screen {
            text-align: center;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: var(--radius-lg);
            color: white;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }
        
        .title-wrapper {
            margin-bottom: 1.5rem;
        }
        
        .product-name {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(1.25rem);
            animation: fadeInUp 0.8s ease forwards;
        }
        
        .subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            opacity: 0;
            transform: translateY(1.25rem);
            animation: fadeInUp 0.8s ease 0.2s forwards;
        }
        
        .product-description {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 20rem;
            margin: 0 auto;
            line-height: 1.5;
            opacity: 0;
            transform: translateY(1.25rem);
            animation: fadeInUp 0.8s ease 0.4s forwards;
            margin-top: 0.75rem;
        }
        
        .start-btn {
            background: white;
            color: var(--primary);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .product-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }
        
        .product-footer a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        
        .product-footer a:hover {
            color: var(--primary-light);
        }
        
        .heart-icon {
            color: #ff4d6d;
            animation: heartbeat 1.5s infinite;
            margin: 0 3px;
        }
        
        /* Chat App Content Styles */
        .content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .header {
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background-color: var(--primary);
            color: white;
        }
        
        .header-title {
            font-weight: 700;
            font-size: 1.25rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 2.5rem;
            height: 1.5rem;
        }
        
        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-label {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: .4s;
            border-radius: 1.5rem;
        }
        
        .toggle-label:before {
            position: absolute;
            content: "";
            height: 1.125rem;
            width: 1.125rem;
            left: 0.25rem;
            bottom: 0.2rem;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-input:checked + .toggle-label {
            background-color: var(--success);
        }
        
        .toggle-input:checked + .toggle-label:before {
            transform: translateX(1rem);
        }
        
        .toggle-text {
            font-size: 0.625rem;
            margin-left: 0.25rem;
            color: white;
        }
        
        /* Chat messages area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: rgba(246, 248, 252, 0.5);
        }
        
        .message {
            display: flex;
            margin-bottom: 0.5rem;
            animation: fadeIn 0.3s ease;
        }
        
        .message-user {
            justify-content: flex-end;
        }
        
        .message-ai {
            justify-content: flex-start;
        }
        
        .message-content {
            padding: 0.6rem 0.8rem;
            border-radius: var(--radius);
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .message-user .message-content {
            background-color: var(--primary);
            color: white;
            border-radius: var(--radius) var(--radius-sm) var(--radius-sm) var(--radius);
        }
        
        .message-ai .message-content {
            background-color: white;
            color: var(--text);
            border-radius: var(--radius-sm) var(--radius) var(--radius) var(--radius-sm);
            border-left: 4px solid var(--success);
        }
        
        /* Update live transcript styling for new position */
        .live-transcript {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0.4rem 0.6rem;
            margin: 0;
            border-top: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            font-style: italic;
            color: var(--text-light);
            box-shadow: var(--shadow-sm);
            display: none;
            max-height: 80px;
            overflow-y: auto;
            opacity: 0.9;
            font-size: 0.8rem;
            position: relative;
        }
        
        .live-transcript.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        #liveIndicator {
            background-color: #ef4444;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.625rem;
            margin-right: 0.5rem;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }
        
        /* Controls area */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background-color: white;
            border-top: 1px solid var(--border);
        }
        
        .control-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            justify-content: center;
        }
        
        .mic-button {
            height: 3rem;
            width: 3rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        
        .mic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4);
        }
        
        .mic-button.recording {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            animation: pulse-button 2s infinite;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        
        .mic-button i {
            font-size: 1.25rem;
            color: white;
        }
        
        .reset-button {
            height: 2rem;
            width: 2rem;
            border-radius: 50%;
            background-color: #e5e7eb;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reset-button:hover {
            background-color: #d1d5db;
        }
        
        .reset-button i {
            font-size: 0.85rem;
            color: #4b5563;
        }
        
        .status-text {
            font-size: 0.75rem;
            color: var(--text-light);
            text-align: center;
            margin-top: 0.25rem;
        }
        
        /* Screen Sharing Indicator */
        .screen-sharing-active {
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--danger);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.625rem;
            z-index: 9999;
            display: none;
            font-weight: 600;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease;
        }
        
        /* Screen Sharing Mode Styles */
        .screen-sharing-mode .container {
            border: 2px solid var(--danger) !important;
            position: relative;
            overflow: visible !important;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        /* Animations */
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
            }
            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 8px rgba(255, 255, 255, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
            }
        }
        
        @keyframes pulse-button {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        
        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(1.25rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Loading Animation */
        .loading-dots {
            display: inline-flex;
            align-items: center;
            height: 20px;
        }
        .loading-dot {
            background-color: var(--primary);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin: 0 2px;
            animation: loading-dots 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes loading-dots {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Processing spinner */
        .processing-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--primary-light);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-right: 0.375rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Compact toggle switch */
        .toggle-container {
            display: flex;
            align-items: center;
        }
        
        .toggle-switch.compact {
            width: 2rem;
            height: 1.2rem;
            margin-left: 0.25rem;
        }
        
        .toggle-switch.compact .toggle-label:before {
            height: 0.9rem;
            width: 0.9rem;
            left: 0.2rem;
            bottom: 0.15rem;
        }
        
        .toggle-switch.compact .toggle-input:checked + .toggle-label:before {
            transform: translateX(0.8rem);
        }
        
        .toggle-text {
            font-size: 0.7rem;
            margin-left: 0.25rem;
            color: #6b7280;
        }

        /* New: Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--card);
            padding: 0.75rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .modal-content h3 {
            color: var(--primary);
            margin-bottom: 0.25rem;
            font-size: 1.05rem;
        }

        .modal-content p {
            color: var(--text-light);
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
        }

        .modal-content textarea {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            resize: vertical;
            min-height: 60px;
            max-height: 150px;
        }

        .modal-content .start-btn, .modal-content .reset-button {
            margin-top: 0;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .modal-content .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.4rem;
            margin-top: 0.4rem;
        }

        .modal-content .reset-button {
            background-color: #f1f5f9;
            color: var(--text-light);
        }

        .modal-content .reset-button:hover {
            background-color: #e2e8f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sign In Screen -->
        <div id="signInScreen" class="sign-in-screen">
            <div class="title-wrapper">
                <h2 class="product-name">Angel</h2>
                <h1 class="subtitle">AI Meeting Assistant</h1>
                <p class="product-description">
                    Sign in to access your AI meeting assistant
                </p>
            </div>
            <button class="sign-in-btn" id="signInButton">
                <i class="fab fa-google"></i>
                Sign in with Google
            </button>
            <div class="product-footer">
                <span>A product from </span>
                <a href="https://lazyjobseeker.com" target="_blank">LazyJobSeeker.com</a>
                <span style="margin: 0 5px;">•</span>
                <span>Made with </span>
                <i class="fas fa-heart heart-icon"></i>
            </div>
        </div>

        <!-- Upgrade Prompt (initially hidden) -->
        <div id="upgradePrompt" class="upgrade-prompt hidden">
            <h3>Upgrade Required</h3>
            <p>To use Angel AI Meeting Assistant, you need an Ultimate plan subscription.</p>
            <a href="https://lazyjobseeker.com/pricing" target="_blank" class="upgrade-btn">
                Upgrade Now
            </a>
        </div>

        <!-- Welcome Screen (initially hidden) -->
        <div id="welcomeScreen" class="welcome-screen hidden">
            <div class="title-wrapper">
                <h2 class="product-name">Angel</h2>
                <h1 class="subtitle">AI Meeting Assistant</h1>
                <p class="product-description">
                    Silent, Smart, and Always On top
                </p>
            </div>
            <button id="startApp" class="start-btn hidden">
                <i class="fas fa-play-circle"></i> Start Assistant
            </button>
            <!-- New: Provide Profile Button on Welcome Screen -->
            <button id="provideProfileButtonWelcome" class="start-btn" title="Provide your resume for interview mode" style="margin-top: 1rem;">
                <i class="fas fa-user"></i> Provide Profile
            </button>
            <div class="product-footer">
                <span>A product from </span>
                <a href="https://lazyjobseeker.com" target="_blank">LazyJobSeeker.com</a>
                <span style="margin: 0 5px;">•</span>
                <span>Made with </span>
                <i class="fas fa-heart heart-icon"></i>
            </div>
        </div>

        <!-- Main App Content (initially hidden) -->
        <div id="appContent" class="content hidden">
            <!-- Screen Sharing Indicator -->
            <div id="screenSharingIndicator" class="screen-sharing-active">
                <i class="fas fa-desktop"></i> Hiding from Screen Capture...
            </div>
            
            <!-- Chat Messages Area - no header -->
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome message -->
                <div class="message message-ai">
                    <div class="message-content">
                        Hello! I'm your AI meeting assistant. Press the microphone button or spacebar to start recording.
                    </div>
                </div>
            </div>
            
            <!-- Live transcript moved here, between chat messages and controls -->
            <div id="liveTranscript" class="live-transcript">
                <span id="liveIndicator" class="hidden">LIVE</span>
                <span id="transcriptText">Waiting for speech...</span>
            </div>
            
            <!-- Controls Area -->
            <div class="controls">
                <div class="control-buttons">
                    <button id="micButton" class="mic-button">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="resetButton" class="reset-button">
                        <i class="fas fa-refresh"></i>
                    </button>
                    <!-- Hide toggle moved here -->
                    <div class="toggle-container">
                        <div class="toggle-switch compact">
                            <input type="checkbox" id="screenSharingMode" class="toggle-input">
                            <label for="screenSharingMode" class="toggle-label"></label>
                            <span class="toggle-text">Hide</span>
                        </div>
                    </div>
                </div>
                <div id="statusText" class="status-text">
                    Press microphone button or spacebar to start recording
                </div>
            </div>
        </div>
    </div>
    
    <!-- New: Profile Input Modal -->
    <div id="profileInputModal" class="modal hidden">
        <div class="modal-content">
            <h3>Provide Your Resume</h3>
            <p>Paste your resume text below. This will help Angel answer questions during interviews based on your profile.</p>
            <textarea id="resumeTextArea" placeholder="Paste your resume text here..." rows="15"></textarea>
            <div class="button-group">
                <button id="cancelProfileButton" class="reset-button">Cancel</button>
                <button id="saveProfileButton" class="start-btn">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        const { ipcRenderer } = require('electron');
        
        // Add error handling for IPC
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        // Add unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
        
        // Get all necessary DOM elements
        const startAppButton = document.getElementById('startApp');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const appContent = document.getElementById('appContent');
        const screenSharingToggle = document.getElementById('screenSharingMode');
        const micButton = document.getElementById('micButton');
        const resetButton = document.getElementById('resetButton');
        const statusText = document.getElementById('statusText');
        const chatMessages = document.getElementById('chatMessages');
        const liveTranscript = document.getElementById('liveTranscript');
        const transcriptText = document.getElementById('transcriptText');
        const liveIndicator = document.getElementById('liveIndicator');
        const signInScreen = document.getElementById('signInScreen');
        const upgradePrompt = document.getElementById('upgradePrompt');
        const signInButton = document.getElementById('signInButton');
        
        // New: Profile Input Modal Elements
        const provideProfileButton = document.getElementById('provideProfileButton');
        const profileInputModal = document.getElementById('profileInputModal');
        const resumeTextArea = document.getElementById('resumeTextArea');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const cancelProfileButton = document.getElementById('cancelProfileButton');
        
        // New: Reference the new button on the welcome screen
        const provideProfileButtonWelcome = document.getElementById('provideProfileButtonWelcome');
        
        // Add console logs for debugging
        console.log('Initializing application...');
        
        let isRecording = false;
        let isProcessingToggle = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let messages = [];
        let userProfileProvided = false; // New state to track if user profile is provided

        // Make sure appContent is hidden initially
        appContent.classList.add('hidden');
        
        // Disable mic button by default until profile is provided
        micButton.disabled = true;
        micButton.style.opacity = '0.5';
        micButton.style.cursor = 'not-allowed';
        
        // Function to show loading animation
        function showLoadingAnimation() {
            return `<div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>`;
        }
        
        // Function to add a message to the chat
        function addMessage(text, isUser = false) {
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'message-user' : 'message-ai'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = text;
            
            messageDiv.appendChild(messageContent);
            
            // Add to chat
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store in messages array
            messages.push({ text, isUser });
        }
        
        // Function to update live transcript
        function updateLiveTranscript(text) {
            if (text && text.trim()) {
                transcriptText.textContent = text;
                liveTranscript.classList.add('active');
                
                // Make sure live indicator is visible when transcribing
                if (isRecording) {
                    liveIndicator.classList.remove('hidden');
                }
            } else {
                liveTranscript.classList.remove('active');
            }
        }
        
        // Update status text
        function updateStatus(text) {
            statusText.textContent = text;
        }
        
        // Start button click handler
        startAppButton.addEventListener('click', () => {
            welcomeScreen.classList.add('hidden');
            appContent.classList.remove('hidden');
        });

        // Initialize audio recording
        async function initializeRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 48000,
                        channelCount: 1
                    }
                });
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 128000
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                return true;
            } catch (error) {
                console.error('Error initializing recording:', error);
                addMessage(`Error: ${error.message}`, false);
                return false;
            }
        }

        // Toggle recording function
        async function toggleRecording() {
            // New: Check if user profile is provided
            if (!userProfileProvided) {
                updateStatus('Please provide your resume to start the assistant.');
                return; 
            }

            try {
                // If already processing a toggle, ignore this request
                if (isProcessingToggle) return;
                isProcessingToggle = true;
                
                // If mediaRecorder is null, initialize it
                if (!mediaRecorder) {
                    const initialized = await initializeRecording();
                    if (!initialized) {
                        isProcessingToggle = false;
                        return;
                    }
                }

                // Check recording state and handle accordingly
                if (!isRecording) {
                    // Starting a new recording
                    audioChunks = [];
                    console.log('Starting recording');
                    
                    // Update UI
                    micButton.classList.add('recording');
                    micButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                    updateStatus('Listening... Click microphone or press spacebar to stop');
                    
                    // Show and reset the live transcript
                    updateLiveTranscript('Listening...');
                    liveIndicator.classList.remove('hidden');
                    
                    // Configure streaming data handler for real-time chunks
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                            
                            // Process the chunk immediately for streaming
                            const reader = new FileReader();
                            reader.onload = () => {
                                const base64Audio = reader.result.split(',')[1];
                                // Send this chunk to the main process for real-time processing
                                ipcRenderer.send('stream-audio-chunk', base64Audio);
                            };
                            reader.readAsDataURL(event.data);
                        }
                    };
                    
                    // Start recording with smaller timeslice for more frequent updates
                    mediaRecorder.start(100);
                    
                    // Signal to main process that we're starting to record
                    ipcRenderer.send('toggle-recording', true);
                    
                    isRecording = true;
                } else {
                    // Stopping recording
                    console.log('Stopping recording');
                    
                    // Update UI
                    micButton.classList.remove('recording');
                    micButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    updateStatus('Processing...');
                    
                    // Hide live indicator
                    liveIndicator.classList.add('hidden');
                    
                    // Tell the main process to stop recording
                    ipcRenderer.send('stop-audio-stream');
                    ipcRenderer.send('toggle-recording', false);
                    
                    // Stop the MediaRecorder
                    try {
                        mediaRecorder.stop();
                        const tracks = mediaRecorder.stream.getTracks();
                        tracks.forEach(track => track.stop());
                    } catch (error) {
                        console.error('Error stopping MediaRecorder:', error);
                    }
                    
                    // Create new MediaRecorder instance for next recording
                    mediaRecorder = null;
                    
                    isRecording = false;
                }
                
                // Reset the processing flag with a slight delay to prevent double toggles
                setTimeout(() => {
                    isProcessingToggle = false;
                }, 300);
            } catch (error) {
                console.error('Error toggling recording:', error);
                addMessage(`Error: ${error.message}`, false);
                
                // Reset UI
                micButton.classList.remove('recording');
                micButton.innerHTML = '<i class="fas fa-microphone"></i>';
                updateStatus('Error recording. Please try again.');
                
                // Reset state
                isRecording = false;
                isProcessingToggle = false;
                mediaRecorder = null;
            }
        }
        
        // Reset conversation
        function resetConversation() {
            // Clear messages except the first welcome message
            while (chatMessages.children.length > 1) {
                chatMessages.removeChild(chatMessages.lastChild);
            }
            
            // Hide transcript
            liveTranscript.classList.remove('active');
            
            // Reset messages array except welcome message
            messages = messages.slice(0, 1);
            
            // Reset status
            updateStatus('Conversation reset. Press microphone or spacebar to start recording');
            
            // Tell main process to reset transcript
            ipcRenderer.send('reset-transcript');
        }
        
        // Mic button click handler
        micButton.addEventListener('click', toggleRecording);
        
        // Reset button click handler
        resetButton.addEventListener('click', resetConversation);
        
        // Add spacebar handler for toggling recording
        document.addEventListener('keydown', (event) => {
            // Check if key is spacebar and not in an input field
            if (event.code === 'Space' && 
                document.activeElement.tagName !== 'INPUT' && 
                document.activeElement.tagName !== 'TEXTAREA') {
                // Prevent default scrolling behavior
                event.preventDefault();
                // Toggle recording
                toggleRecording();
            }
        });
        
        // Screen sharing mode toggle handler
        screenSharingToggle.addEventListener('change', () => {
            const isHideMode = screenSharingToggle.checked;
            
            // First update UI immediately to give user feedback
            const indicator = document.getElementById('screenSharingIndicator');
            
            if (isHideMode) {
                // Show screen sharing mode indicator
                indicator.style.display = 'block';
                console.log('Requested screen sharing hide mode');
            } else {
                // Hide indicators
                indicator.style.display = 'none';
                console.log('Requested normal mode');
            }
            
            // Then tell main process to apply the actual exclusion
            ipcRenderer.send('toggle-screen-sharing-mode', isHideMode);
        });
        
        // New: Provide Profile button handlers (now for the new button)
        provideProfileButtonWelcome.addEventListener('click', () => {
            profileInputModal.classList.remove('hidden');
            resumeTextArea.value = ''; // Clear previous text
        });

        cancelProfileButton.addEventListener('click', () => {
            profileInputModal.classList.add('hidden');
            resumeTextArea.value = '';
        });

        saveProfileButton.addEventListener('click', async () => {
            const resumeText = resumeTextArea.value.trim();
            if (resumeText) {
                // Send resume text to main process
                await ipcRenderer.invoke('save-user-profile', resumeText);
                userProfileProvided = true;
                profileInputModal.classList.add('hidden');
                updateStatus('Profile saved! Use Spacebar to control Angel.');
                // Re-check auth state to update UI if needed (e.g., enable start button)
                checkAuth(); 
            } else {
                alert('Please paste your resume text.');
            }
        });
        
        // IPC event handlers
        
        // Handle live transcript updates
        ipcRenderer.on('transcript', (event, text) => {
            if (text && text.trim() && text !== 'Recording...') {
                updateLiveTranscript(text);
            }
        });

        // Handle recording started
        ipcRenderer.on('recording-started', () => {
            console.log('Recording started signal received');
        });
        
        // Handle recording stopped
        ipcRenderer.on('recording-stopped', () => {
            console.log('Recording stopped signal received');
            
            // Update UI if needed
            if (isRecording) {
                isRecording = false;
                micButton.classList.remove('recording');
                micButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        });
        
        // Handle answers
        ipcRenderer.on('answer', (event, text) => {
            // Get transcript text
            const transcript = transcriptText.textContent;
            
            // Only add transcript and answer if not empty
            if (transcript && transcript !== 'Listening...' && transcript !== 'Waiting for speech...') {
                // Add the transcript as a user message
                addMessage(transcript, true);
                
                // Add the answer
                if (text && text.trim()) {
                    addMessage(text, false);
                } else {
                    addMessage('No answer received. Please try again.', false);
                }
            } else {
                addMessage('No speech detected. Please try again.', false);
            }
            
            // Update status
            updateStatus('Press microphone or spacebar to start recording');
        });
        
        // Handle answer status updates
        ipcRenderer.on('answer-status', (event, message) => {
            updateStatus(message);
        });
        
        // Handle transcription errors
        ipcRenderer.on('transcription-error', (event, errorMessage) => {
            console.error('Transcription error:', errorMessage);
            addMessage(`Error: ${errorMessage}`, false);
            updateStatus('Error during transcription. Please try again.');
        });
        
        // Initialize recording when the app starts
        initializeRecording().then(success => {
            if (!success) {
                updateStatus('Failed to initialize microphone. Please check permissions.');
            }
        });

        // Check authentication status on load
        async function checkAuth() {
            try {
                console.log('Checking authentication status...');
                const result = await ipcRenderer.invoke('check-auth');
                console.log('Auth check result:', result);
                if (result.isAuthenticated) {
                    if (result.hasAccess) {
                        showWelcomeScreen();
                    } else {
                        showUpgradePrompt(result.planName);
                    }
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }
        
        // Handle sign-in button click
        signInButton.addEventListener('click', async () => {
            try {
                console.log('Sign in button clicked');
                signInButton.disabled = true;
                signInButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';

                const result = await ipcRenderer.invoke('sign-in');
                console.log('Sign-in result:', result);

                if (result.success) {
                    if (result.hasAccess) {
                        showWelcomeScreen();
                    } else {
                        showUpgradePrompt(result.planName);
                    }
                } else {
                    throw new Error('Authentication failed');
                }
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed: ' + error.message);
            } finally {
                signInButton.disabled = false;
                signInButton.innerHTML = '<i class="fab fa-google"></i> Sign in with Google';
            }
        });
        
        // Show upgrade prompt
        function showUpgradePrompt(currentPlan) {
            console.log('Showing upgrade prompt for plan:', currentPlan);
            signInScreen.classList.add('hidden');
            welcomeScreen.classList.add('hidden');
            appContent.classList.add('hidden');
            upgradePrompt.classList.remove('hidden');
            startAppButton.classList.add('hidden'); // Ensure start button is hidden
        }
        
        // Show welcome screen
        function showWelcomeScreen() {
            console.log('Showing welcome screen');
            signInScreen.classList.add('hidden');
            upgradePrompt.classList.add('hidden');
            appContent.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            
            // Only show start button if profile is provided
            if (userProfileProvided) {
                startAppButton.classList.remove('hidden');
                startAppButton.disabled = false; // Ensure it's enabled
                provideProfileButtonWelcome.classList.add('hidden'); // Hide profile button
                updateStatus('Welcome! Profile loaded. Press microphone button or spacebar to start recording.');
                micButton.disabled = false;
                micButton.style.opacity = '1';
                micButton.style.cursor = 'pointer';
            } else {
                startAppButton.classList.add('hidden');
                startAppButton.disabled = true; // Ensure it's disabled
                provideProfileButtonWelcome.classList.remove('hidden'); // Show profile button
                updateStatus('Please provide your resume to start the assistant.');
                micButton.disabled = true;
                micButton.style.opacity = '0.5';
                micButton.style.cursor = 'not-allowed';
            }
        }
        
        // Initial check on app load
        checkAuth();

        // Add these event listeners after the existing ones
        ipcRenderer.on('auth-complete', (event, result) => {
            console.log('Auth complete:', result);
            if (result.hasAccess) {
                showWelcomeScreen();
            } else {
                showUpgradePrompt(result.planName);
            }
        });

        ipcRenderer.on('auth-error', (event, error) => {
            console.error('Auth error:', error);
            alert('Authentication failed: ' + error);
            // Reset button state
            signInButton.disabled = false;
            signInButton.innerHTML = '<i class="fab fa-google"></i> Sign in with Google';
        });

        // New IPC handler for profile status from main process (e.g., if profile was loaded from persistence)
        ipcRenderer.on('profile-status', (event, isProvided) => {
            userProfileProvided = isProvided;
            // Re-check auth status to update UI after profile status is known
            checkAuth();
        });
    </script>
</body>
</html>